------------------------------Account Opportunity Cloning Trigger Handler------------------------
public class NewBusinessTriggerHandler { 
    public static void Newbusinessrecordinsert(list<Opportunity> newlist, map<id,Opportunity> oldmap){
                if(Schema.SObjectType.Opportunity.isAccessible()) {
        	try {
                list<Opportunity> insertopp = new list<Opportunity>();
                id NewBusinessRecordId = [select id,name from RecordType where name='New Business'].id;
                id RenewalId = [select id,name from RecordType where name='Renewal'].id;
        
                for(opportunity renewalobj : newlist){
                    if(renewalobj.RecordTypeId == NewBusinessRecordId && renewalobj.StageName == 'Closed Won'){
                        opportunity obj = renewalobj.clone();
                        obj.RecordTypeId = RenewalId;
                        obj.StageName = 'Renewal';
                        obj.Name = renewalobj.Name+'-Renewal';
                        obj.CloseDate = renewalobj.CloseDate.addDays(30);
                        obj.Parent_Opportunity__c = renewalobj.id;
                        insertopp.add(obj);
                    }
                }
                
                //Check list then insert
                if(!insertopp.isEmpty()){
                    insert insertopp;
                }
            }
            catch(Exception ex){
                system.debug('Error Occur : ' +ex.getMessage());
            }
       	}
       }
   		//Method for updating NewBusiness Recordtype Opportunity
       public static void Newbusinessrecordupdate(list<Opportunity> newlist, map<id,Opportunity> oldmap) {
        if (Schema.SObjectType.Opportunity.isUpdateable()) {
            try {
                Set<Id> originId = oldmap.keySet();
                list<Opportunity> updateopp = new list<Opportunity>();
                id NewBusinessRecordId = [select id, name from RecordType where name = 'New Business'].id;
                id RenewalId = [select id, name from RecordType where name = 'Renewal'].id;
                Map<Id, Opportunity> renewalOpps = new Map<Id, Opportunity>();
                Set<Id> oppsWithInstallationFee = new Set<Id>();
                
                // Get the original opportunities with InstallationFee
                for (OpportunityLineItem lineItem : [SELECT OpportunityId FROM OpportunityLineItem WHERE OpportunityId = :originId AND PricebookEntry.Product2.Name = 'InstallationFee']) {
                    oppsWithInstallationFee.add(lineItem.OpportunityId);
                }
        
                for (Opportunity renewalupdateobj : newlist) {
                    if (renewalupdateobj.StageName != oldmap.get(renewalupdateobj.id).StageName && renewalupdateobj.RecordTypeId == NewBusinessRecordId && renewalupdateobj.StageName == 'Closed Won') {
                        // Check if original opportunity has installation fee line item
                        if (oppsWithInstallationFee.contains(renewalupdateobj.Id)) {
                            opportunity obj = renewalupdateobj.clone();
                            obj.RecordTypeId = RenewalId;
                            obj.StageName = 'Renewal';
                            obj.Name = renewalupdateobj.Name + '-Renewal';
                            obj.CloseDate = renewalupdateobj.CloseDate.addDays(30);
                            obj.Parent_Opportunity__c = renewalupdateobj.id;
                            updateopp.add(obj);
        
                            renewalOpps.put(renewalupdateobj.Id, obj);
                        } else {
                            // Throw error if original opportunity doesn't have installation fee line item
                            renewalupdateobj.addError('Opportunity must have InstallationFee line item before being closed and cloned.');
                        }
                    }
                }
        
                //Check list then insert
                if (!updateopp.isEmpty()) {
                    insert updateopp;
                }
        
                List<OpportunityLineItem> clonedLineItems = new List<OpportunityLineItem>();
                if (!updateopp.isEmpty()) {
                    // Only query the line items once
                    List<OpportunityLineItem> origLineItems = [SELECT Id, PricebookEntryId, Quantity, UnitPrice, PricebookEntry.Product2.Name, OpportunityId FROM OpportunityLineItem WHERE OpportunityId = :originId];
                    for (OpportunityLineItem origLineItem : origLineItems) {
                        if (origLineItem.PricebookEntry.Product2.Name != 'InstallationFee') { // exclude the installation fee product
                            OpportunityLineItem clonedLineItem = origLineItem.clone();
                            clonedLineItem.OpportunityId = renewalOpps.get(origLineItem.OpportunityId).Id;
                            clonedLineItems.add(clonedLineItem);
                        }
                    }
                    system.debug('CloneItem ===>' + clonedLineItems);
                }
        
                //Check list then insert
                if (!clonedLineItems.isEmpty()) {
                    insert clonedLineItems;
                }
        
            } catch (Exception ex) {
                system.debug('Error Occur : ' + ex.getMessage());
            }
        }
	}

    
     //Method for updating Renewal Recordtype Opportunity
     public static void Renewalrecordupdate(list<Opportunity> newlist, map<id,Opportunity> oldmap){
           if (Schema.SObjectType.Opportunity.isUpdateable()) {
        try {
            Set<Id> originId = oldmap.keySet();
            list<Opportunity> updateopp = new list<Opportunity>();
            id NewBusinessRecordId = [select id,name from RecordType where name='New Business'].id;
            id RenewalId = [select id,name from RecordType where name='Renewal'].id;
            Map<Id, Opportunity> renewalOpps = new Map<Id, Opportunity>();

            for (opportunity renewalupdateobj : newlist) {
                if (renewalupdateobj.StageName != oldmap.get(renewalupdateobj.id).StageName && renewalupdateobj.RecordTypeId == RenewalId && renewalupdateobj.StageName=='Closed Won') {
                    opportunity obj = renewalupdateobj.clone();
                    obj.RecordTypeId = RenewalId;
                    obj.StageName = 'Renewal';
                    obj.Name = renewalupdateobj.Name+'-Renewal';
                    obj.CloseDate = renewalupdateobj.CloseDate.addDays(30);
                    obj.Parent_Opportunity__c = renewalupdateobj.id;
                    updateopp.add(obj);

                    renewalOpps.put(renewalupdateobj.Id, obj);
                }
            }

            //Check list then insert
            if(!updateopp.isEmpty()){
                insert updateopp;
            }

            List<OpportunityLineItem> clonedLineItems = new List<OpportunityLineItem>();
            if(!updateopp.isEmpty()){
                for (OpportunityLineItem origLineItem : [SELECT Id, PricebookEntryId, Quantity, UnitPrice,PricebookEntry.Product2.Name, OpportunityId FROM OpportunityLineItem WHERE OpportunityId = : originId]) {
                        OpportunityLineItem clonedLineItem = origLineItem.clone();
                        clonedLineItem.OpportunityId = renewalOpps.get(origLineItem.OpportunityId).Id;
                        clonedLineItems.add(clonedLineItem);
                    }
                system.debug('CloneItem ===>'+clonedLineItems);
            }

            //Check list then insert
            if(!clonedLineItems.isEmpty()){
                insert clonedLineItems;
            }

        } catch(Exception ex){
            system.debug('Error Occur : ' +ex.getMessage());
        }
    }
    }
}


-------------------------Trigger----------------------------

trigger NewBusiness_Trigger on Opportunity (after insert, after update) {
  
   if(trigger.isafter && trigger.isinsert){
      
        NewBusinessTriggerHandler.Newbusinessrecordinsert(trigger.new, trigger.oldmap);
    }
     if(trigger.isafter && trigger.isupdate){
       
        NewBusinessTriggerHandler.Newbusinessrecordupdate(trigger.new, trigger.oldmap);
    } 
    RecordType renewaltype = [select id, name from recordtype where name = 'Renewal'];
    for(Opportunity op: trigger.new){
        if(op.recordTypeId == renewaltype.id){
            NewBusinessTriggerHandler.Renewalrecordupdate(trigger.new, trigger.oldmap);
        }
	}
}
